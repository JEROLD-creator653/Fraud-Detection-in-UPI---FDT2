<!DOCTYPE html>
<html>
<head>
    <title>Chatbot Direct Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        #messages { border: 1px solid #ccc; height: 400px; overflow-y: auto; padding: 10px; margin-bottom: 10px; background: #f9f9f9; }
        .user { color: blue; text-align: right; margin: 5px 0; }
        .bot { color: green; margin: 5px 0; white-space: pre-wrap; }
        .error { color: red; }
        #input { width: 80%; padding: 10px; }
        #send { padding: 10px 20px; }
        #log { background: #f0f0f0; padding: 10px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Chatbot Direct Test (No Cache)</h1>
    <p>This test bypasses browser cache. Type a message below:</p>
    
    <div id="messages"></div>
    <input type="text" id="input" placeholder="Type a message..." onkeypress="if(event.key==='Enter')send()">
    <button id="send" onclick="send()">Send</button>
    
    <h3>Debug Log:</h3>
    <div id="log"></div>
    
    <script>
        const messagesDiv = document.getElementById('messages');
        const inputEl = document.getElementById('input');
        const logDiv = document.getElementById('log');
        
        function log(msg) {
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${msg}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }
        
        function addMessage(content, isUser) {
            const div = document.createElement('div');
            div.className = isUser ? 'user' : 'bot';
            div.textContent = (isUser ? 'You: ' : 'Bot: ') + content;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function addError(content) {
            const div = document.createElement('div');
            div.className = 'error';
            div.textContent = 'ERROR: ' + content;
            messagesDiv.appendChild(div);
        }
        
        async function send() {
            const msg = inputEl.value.trim();
            if (!msg) return;
            
            addMessage(msg, true);
            inputEl.value = '';
            
            log('Sending: ' + msg);
            
            try {
                const startTime = Date.now();
                const response = await fetch('/api/chatbot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: msg,
                        time_range: '24h',
                        history: []
                    })
                });
                
                log(`Response status: ${response.status} (${Date.now() - startTime}ms)`);
                log(`Content-Type: ${response.headers.get('content-type')}`);
                
                const text = await response.text();
                log(`Raw response length: ${text.length} chars`);
                log(`Raw response preview: ${text.substring(0, 200)}...`);
                
                let data;
                try {
                    data = JSON.parse(text);
                    log(`Parsed JSON keys: ${Object.keys(data).join(', ')}`);
                } catch (e) {
                    log('JSON PARSE ERROR: ' + e.message);
                    addError('Failed to parse JSON: ' + e.message);
                    return;
                }
                
                if (data.response) {
                    log(`Response has "response" key with ${data.response.length} chars`);
                    addMessage(data.response, false);
                } else if (data.error) {
                    log(`Server returned error: ${data.error}`);
                    addError(data.error);
                } else {
                    log('Unexpected response format');
                    addError('Unexpected response: ' + JSON.stringify(data));
                }
                
            } catch (e) {
                log('FETCH ERROR: ' + e.message);
                log('Error stack: ' + e.stack);
                addError(e.message);
            }
        }
        
        // Initial test
        log('Page loaded. Ready to test chatbot.');
        log('Try typing "hello" or "how many transactions"');
    </script>
</body>
</html>
